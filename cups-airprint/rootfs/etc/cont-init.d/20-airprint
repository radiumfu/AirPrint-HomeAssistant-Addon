# cups-airprint/rootfs/etc/cont-init.d/20-airprint
#!/usr/bin/with-contenv bash
# shellcheck shell=bash
set -euo pipefail


# Generate AirPrint Avahi service files from CUPS queues
# The bundled script connects to localhost:631 and writes *.service files to /etc/avahi/services
/usr/local/bin/airprint-generate.py -d /etc/avahi/services || true


# Optionally enable Avahi reflector (crossâ€‘subnet mDNS)
CONFIG_PATH=/data/options.json
REFLECTOR=$(jq -r '.avahi_reflector' "$CONFIG_PATH")
if [ "$REFLECTOR" = "true" ]; then
sed -i 's/^#*enable-reflector=.*/enable-reflector=yes/' /etc/avahi/avahi-daemon.conf
else
sed -i 's/^#*enable-reflector=.*/enable-reflector=no/' /etc/avahi/avahi-daemon.conf
fi