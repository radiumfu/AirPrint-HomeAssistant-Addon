# cups-airprint/rootfs/etc/cont-init.d/10-setup
#!/usr/bin/with-contenv bash
# shellcheck shell=bash
set -euo pipefail


# Read user options
CONFIG_PATH=/data/options.json
ADMIN_USER=$(jq -r '.admin_user' "$CONFIG_PATH")
ADMIN_PASS=$(jq -r '.admin_password' "$CONFIG_PATH")
SHARE=$(jq -r '.share_printers' "$CONFIG_PATH")


# Persist CUPS config to /data
if [ ! -d "/data/cups" ]; then
mkdir -p /data/cups
cp -a /etc/cups/. /data/cups/
fi
rm -rf /etc/cups
ln -sf /data/cups /etc/cups


# Create CUPS admin account
if ! id "$ADMIN_USER" &>/dev/null; then
useradd -r -M -s /sbin/nologin "$ADMIN_USER" || true
fi
echo "$ADMIN_USER:$ADMIN_PASS" | chpasswd
addgroup "$ADMIN_USER" lpadmin || true


# Configure cupsd.conf from template if missing
if [ ! -f /etc/cups/cupsd.conf ]; then
cp /defaults/cupsd.conf /etc/cups/cupsd.conf
fi


# Toggle sharing
if [ "$SHARE" = "true" ]; then
sed -i 's/^#DefaultShared Yes/DefaultShared Yes/' /etc/cups/cupsd.conf || true
else
sed -i 's/^DefaultShared Yes/#DefaultShared Yes/' /etc/cups/cupsd.conf || true
fi


# Fix permissions
chown -R root:lp /etc/cups
chmod -R 755 /etc/cups